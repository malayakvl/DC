# Multi-Tenant Система Клиник

## 1. Архитектура базы данных

### Core схема (`core`)

* **users** — все пользователи системы
  Поля: id, name, email, password, ...
* **user_clinic_roles**
  Поля: user_id (core.users.id), clinic_id, role_id
  Описание: определяет, в каких клиниках состоит пользователь

### Схемы клиник (`clinic_{id}`)

* Каждая клиника хранится в отдельной схеме
* Таблицы внутри схемы:

  * **clinic_filials** — филиалы клиники
  * **clinic_filial_user** — pivot user → филиал → роль
  * **roles**, **permissions**, **model_has_roles**, **model_has_permissions** (Spatie)
  * **services**, **stores**, **currencies**, **clinic_patient_data**, ...

#### Пример структуры `clinic_filial_user`:

| clinic_id | filial_id | user_id | role_id |

---

## 2. Роли и права

* Роли по умолчанию:

  * `ceo` — полные права в клинике
  * `ceo_filial` — права админа филиала
  * `doctor`
  * `nurse`
  * `reception`
  * `patient`
* Права назначаются через Spatie **внутри схемы клиники**

  * model_id = core.users.id
  * model_type = App\Models\User

---

## 3. Middleware

### TenantContextMiddleware

* Проверяет сессию:

  * `clinic_id`
  * `filial_id`
* Если нет → предлагает выбор клиники/филиала
* После выбора сохраняет в сессии

### ClinicPermissionMiddleware

* Переключает search_path на clinic_{id}
* Сбрасывает кеш Spatie
* Проверяет права пользователя на выбранный филиал

---

## 4. Сценарий регистрации пользователя и клиники

1. Регистрация в `core.users`
2. Создание новой схемы клиники `clinic_{id}`
3. Создание дефолтного филиала
4. Создание ролей и permissions внутри схемы
5. Привязка пользователя к дефолтному филиалу с ролью `ceo`
6. Сохранение `clinic_id` и `filial_id` в сессии

---

## 5. Добавление филиалов

* Создаём новую запись в `clinic_filials`
* Добавляем пользователей в новый филиал через `clinic_filial_user`
* Роли пользователей для нового филиала назначаются через интерфейс распределения ролей

---

## 6. Добавление пользователей (врачи, медсестры, пациенты)

* Пользователи живут в core.users
* Каждому пользователю назначается:

  * филиал (`filial_id`)
  * роль в филиале (`role_id`)
  * запись в `clinic_filial_user`
* Для пациентов:

  * роль = `patient`
  * опционально создаётся запись в `clinic_patient_data` для хранения скидок и баланса

---

## 7. Пример распределения ролей по филиалам

| Филиал   | Пользователь   | Роль         |
| -------- | -------------- | ------------ |
| Филиал 1 | Иван Иванов    | doctor       |
| Филиал 1 | Анна Петрова   | nurse        |
| Филиал 1 | Сергей Сидоров | patient      |
| Филиал 2 | Иван Иванов    | receptionist |
| Филиал 2 | Анна Петрова   | doctor       |
| Филиал 2 | Мария Смирнова | patient      |

> Каждый пользователь может иметь разные роли в разных филиалах.
> Привязка к филиалу через `clinic_filial_user`, роли через `model_has_roles` в схеме клиники.

---

## 8. Интерфейс распределения ролей по филиалам (для админа)

### Цель

Позволить назначать пользователям роли **по каждому филиалу отдельно**.

### Компоненты интерфейса

1. Выбор филиала (dropdown)
2. Список пользователей
3. Колонка с текущей ролью (редактируемая)
4. Кнопка "Сохранить изменения" (обновляет `clinic_filial_user` и Spatie роли)

### Логика

* При выборе филиала фильтруется список пользователей для него
* Для каждого пользователя можно назначить одну или несколько ролей
* При сохранении:

  1. Обновляется pivot `clinic_filial_user` (`filial_id`, `user_id`, `role_id`)
  2. В схеме клиники обновляются роли Spatie (`model_has_roles`)
* Создатель клиники (`ceo`) видит все филиалы и может назначать любые роли

### Пример интерфейса (псевдо-таблица)

| Филиал   | Пользователь   | Роль         | Действие |
| -------- | -------------- | ------------ | -------- |
| Филиал 1 | Иван Иванов    | doctor       | [Edit]   |
| Филиал 1 | Анна Петрова   | nurse        | [Edit]   |
| Филиал 2 | Иван Иванов    | receptionist | [Edit]   |
| Филиал 2 | Мария Смирнова | patient      | [Edit]   |

---

## 9. Сценарий добавления нового филиала и распределения ролей

1. Создаём филиал (`clinic_filials`) через админку или сервис
2. Новые пользователи по дефолту **не имеют роли в новом филиале**
3. Админ выбирает филиал → открывает список пользователей
4. Назначает роли каждому пользователю через интерфейс
5. Пользователи получают доступ только после назначения ролей
6. Все изменения фиксируются в `clinic_filial_user` и Spatie ролях

---

## 10. Логин

1. Пользователь логинится через `core.users`
2. Middleware проверяет клиники (`core.user_clinic_roles`)
3. Пользователь выбирает клинику и филиал
4. Устанавливаются сессии `clinic_id` и `filial_id`
5. Middleware применяет роли Spatie внутри схемы выбранной клиники
6. Доступ к функционалу ограничен выбранным филиалом и ролями

---

## 11. Flow диаграмма

```mermaid
flowchart LR
    A[Пользователь логинится] --> B{Сколько клиник?}
    B -- 1 --> C[Автовыбор клиники]
    B -- >1 --> D[Выбор клиники]
    C --> E{Сколько филиалов?}
    D --> E
    E -- 1 --> F[Автовыбор филиала]
    E -- >1 --> G[Выбор филиала]
    F --> H[Устанавливаем search_path & права]
    G --> H
    H --> I[Доступ к функционалу в контексте филиала]
```

---

## 12. Примеры SQL вставок

```sql
-- Назначение роли patient пользователю
INSERT INTO clinic_1.model_has_roles (role_id, model_type, model_id)
VALUES ((SELECT id FROM roles WHERE name='patient'), 'App\\Models\\User', 55);

-- Привязка пользователя к филиалу
INSERT INTO clinic_1.clinic_filial_user (clinic_id, filial_id, user_id, role_id)
VALUES (1, 1, 55, (SELECT id FROM roles WHERE name='patient'));
```

---

## 13. Рекомендации по ведению документации

* Держать ERD актуальным (dbdiagram.io, PgAdmin)
* Все middleware и сервисы описывать в Markdown с примерами использования
* Flow диаграммы для сценариев: регистрация, добавление филиалов, логин
* Примеры SQL для добавления ролей и pivot-таблиц
* Хранить документацию в `docs/multi_tenant.md` в репозитории

---

## 14. API для работы с филиалами и ролями

### 14.1 Получение списка филиалов клиники

**Endpoint:** `GET /api/clinics/{clinic_id}/filials`

**Response:**

```json
[
  { "id": 1, "name": "Филиал 1", "address": "ул. Примерная, 10", "clinic_id": 1 },
  { "id": 2, "name": "Филиал 2", "address": "ул. Другая, 5", "clinic_id": 1 }
]
```

---

### 14.2 Получение пользователей филиала с ролями

**Endpoint:** `GET /api/filials/{filial_id}/users`

**Response:**

```json
[
  { "user_id": 55, "name": "Иван Иванов", "roles": ["doctor"] },
  { "user_id": 56, "name": "Анна Петрова", "roles": ["nurse"] }
]
```

---

### 14.3 Назначение роли пользователю в филиале

**Endpoint:** `POST /api/filials/{filial_id}/users/{user_id}/roles`

**Request Body:**

```json
{ "role": "doctor" }
```

**Response:**

```json
{ "success": true, "message": "Роль успешно назначена" }
```

---

### 14.4 Получение всех ролей пользователя в клинике

**Endpoint:** `GET /api/users/{user_id}/roles?clinic_id={clinic_id}`

**Response:**

```json
[
  { "filial_id": 1, "roles": ["doctor"] },
  { "filial_id": 2, "roles": ["receptionist"] }
]
```

---

### 14.5 Добавление нового филиала

**Endpoint:** `POST /api/clinics/{clinic_id}/filials`

**Request Body:**

```json
{ "name": "Филиал 3", "address": "ул. Новая, 12" }
```

**Response:**

```json
{ "id": 3, "name": "Филиал 3", "address": "ул. Новая, 12", "clinic_id": 1 }
```

---

### 14.6 Создание пациента и привязка к филиалу

**Endpoint:** `POST /api/filials/{filial_id}/patients`

**Request Body:**

```json
{ "user_id": 77, "discount": 10, "initial_balance": 500.00 }
```

**Response:**

```json
{
  "success": true,
  "message": "Пациент успешно добавлен",
  "clinic_user_id": 101
}
```
