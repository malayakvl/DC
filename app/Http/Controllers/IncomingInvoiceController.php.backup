<?php

namespace App\Http\Controllers;

use App\Http\Requests\InvoiceUpdateRequest;
use App\Models\Clinic;
use App\Models\ClinicFilial;
use App\Models\Currency;
use App\Models\Filial;
use App\Models\DocumentOperations;
use App\Models\InvoiceItems;
use App\Models\InvoiceStatus;
use App\Models\InvoiceType;
use App\Models\Material;
use App\Models\Producer;
use App\Models\Store;
use App\Models\Invoice;
use App\Models\StoreMaterials;
use App\Models\Tax;
use App\Models\Unit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Redirect;
use Inertia\Inertia;
use Inertia\Response;
use Illuminate\Support\Facades\Storage;


class IncomingInvoiceController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index(Request $request)
    {
        $clinic = $request->user()->clinicByFilial($request->session()->get('clinic_id'));
        $arrStores = array();
        if ($request->user()->roles[0]->name != 'Admin') {
            // get stores filial
            $filialId = $request->session()->get('filial_id');
            $storesData = Store::where('filial_id', '=', $filialId)->get();

            foreach ($storesData as $store) {
                $arrStores[] = $store->id;
            }
        }

        if ($request->user()->roles[0]->name == 'Admin') {
            $invoiceData = DB::table('invoices')
                ->select('invoices.*',
                    'stores.name AS storeName',
                    'invoice_statuses.name as statusName',
                    'invoice_types.name as typeName',
                    'users.name AS customerName',
                    'producers.name AS producerName'
                )
                ->leftJoin('stores', 'stores.id', '=', 'invoices.store_id')
                ->leftJoin('invoice_statuses', 'invoice_statuses.id', '=', 'invoices.status_id')
                ->leftJoin('invoice_types', 'invoice_types.id', '=', 'invoices.type_id')
                ->leftJoin('producers', 'producers.id', '=', 'invoices.producer_id')
                ->leftJoin('users', 'users.id', '=', 'invoices.customer_id')
                ->where('invoices.clinic_id', $clinic->id)
                ->where('invoices.type_id', 1)
                ->orderBy('invoice_number', 'DESC')->get();
        } else {
            $invoiceData = DB::table('invoices')
                ->select('invoices.*',
                    'stores.name AS storeName',
                    'invoice_statuses.name as statusName',
                    'invoice_types.name as typeName',
                    'users.name AS customerName',
                    'producers.name AS producerName'
                )
                ->leftJoin('stores', 'stores.id', '=', 'invoices.store_id')
                ->leftJoin('invoice_statuses', 'invoice_statuses.id', '=', 'invoices.status_id')
                ->leftJoin('invoice_types', 'invoice_types.id', '=', 'invoices.type_id')
                ->leftJoin('producers', 'producers.id', '=', 'invoices.producer_id')
                ->leftJoin('users', 'users.id', '=', 'invoices.customer_id')
                ->whereIn('invoices.store_id', $arrStores)
                ->where('invoices.type_id', 1)
                ->where('invoices.clinic_id', $clinic->id)
                ->orderBy('invoice_number', 'DESC')->get();
        }
        return Inertia::render('InvoiceIncoming/List', [
            'clinicData' => $clinic,
            'listData' => $invoiceData
        ]);
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create(Request $request): Response {
//        dd($request->session()->get('filial_id'));

        if ($request->user()->can('invoice-incoming-create')) {
            $clinicData = Clinic::where('user_id', '=', $request->user()->id)->first();
            $storeData = Store::where('clinic_id', $clinicData->id)->where('filial_id', $request->session()->get('filial_id'))->get();
            $statusData = InvoiceStatus::all();
            $currencyData = Currency::where('clinic_id', $clinicData->id)->get();
            $unitsData = Unit::where('clinic_id', $clinicData->id)->get();
            $taxData = Tax::where('clinic_id', $clinicData->id)->get();
            $typeData = InvoiceType::all();
            $formData = new Invoice();
            $lastInvoiceNum = DB::table('invoices')
                ->where('clinic_id', $clinicData->id)
                ->max('invoice_number');
            if (!$lastInvoiceNum) {
                $num = 1;
            } else {
                $maxNum = (explode('-', $lastInvoiceNum));
                if (intval($maxNum[1])) {
                    $num = intval($maxNum[1]);
                }
                ++$num;
            }
            $formData->invoice_number = date("dmy").'-'.$paddedNumber = str_pad($num, 7, '0', STR_PAD_LEFT);;
            $producerData = Producer::all();
            $customerData = DB::table('users')
                ->select('users.*')
                ->leftJoin('clinic_user', 'users.id', '=', 'clinic_user.user_id')
                ->where('clinic_id', $clinicData->id)
                ->orderBy('name')->get();
            return Inertia::render('InvoiceIncoming/Create', [
                'clinicData' => $clinicData,
                'filialData' => $storeData,
                'formData' => $formData,
                'storeData' => $storeData,
                'customerData' => $customerData,
                'producerData' => $producerData,
                'statusData' => $statusData,
                'typeData' => $typeData,
                'currencyData' => $currencyData,
                'unitsData' => $unitsData,
                'taxData' => $taxData
            ]);
        }
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(Request $request, $id) {
        if ($request->user()->can('invoice-incoming-edit')) {
            $clinicData = Clinic::where('user_id', '=', $request->user()->id)->first();
//            $storeData = Store::where('clinic_id', $clinicData->id)->get();
            $storeData = Store::where('clinic_id', $clinicData->id)->where('filial_id', $request->session()->get('filial_id'))->get();
            $statusData = InvoiceStatus::all();
            $typeData = InvoiceType::all();
            $unitsData = Unit::where('clinic_id', $clinicData->id)->get();
            $formData = Invoice::find($id);
            $currencyData = Currency::where('clinic_id', $clinicData->id)->get();
            $taxData = Tax::where('clinic_id', $clinicData->id)->get();
            $rowData = InvoiceItems::select('invoice_items.*', 'materials.name as product')
                ->leftJoin('materials', 'materials.id', '=', 'invoice_items.product_id')
                ->where('invoice_id', $id)->get();
            $producerData = Producer::all();
            $customerData = DB::table('users')
                ->select('users.*')
                ->leftJoin('clinic_user', 'users.id', '=', 'clinic_user.user_id')
                ->where('clinic_id', $clinicData->id)->orderBy('name')->get();
            return Inertia::render('InvoiceIncoming/Edit', [
                'clinicData' => $clinicData,
                'filialData' => $storeData,
                'formData' => $formData,
                'formRowData' => $rowData,
                'storeData' => $storeData,
                'customerData' => $customerData,
                'producerData' => $producerData,
                'statusData' => $statusData,
                'typeData' => $typeData,
                'currencyData' => $currencyData,
                'unitsData' => $unitsData,
                'taxData' => $taxData
            ]);

        } else {

        }
    }


    /**
     * Display the specified resource.
     */
    public function show(Request $request, $id) {
        //
        if ($request->user()->can('invoice-incoming-view')) {
            $filial = ClinicFilial::find($id);
            return Inertia::render('Store/FilialView', [
                'filialData' => $filial,
            ]);
        } else {

        }
    }



    /**
     * Update the specified resource in storage.
     */
    public function update(InvoiceUpdateRequest $request) {

        if ($request->id) {
            $data = $request;
        } else {
            $data = $request->values;
        }
        if ($request->user()->can('invoice-incoming-edit')) {
            if ($request->id)
                $invoice = Invoice::find($data->id);
            else {
                $invoice = new Invoice();
            }
//            dd($request);exit;
            $invoice->fill($request->validated());
            $invoice->invoice_number = $request->invoice_number;
            $invoice->invoice_date = $request->invoice_date;
            $invoice->status_id = $request->status_id;
            $invoice->type_id = 1;
            $invoice->tax_id = $request->tax_id;
            $invoice->currency_id = $request->currency_id;
            $invoice->save();
            if (!$request->id) {
                $invoiceId = $invoice->id;
            } else {
                $invoiceId = $request->id;
                DB::table('invoice_items')->where('invoice_id', $invoiceId)->delete();
            }
            $producer = Producer::find($request->producer_id);
            $store = Store::find($request->store_id);
            if ($request->status_id === 2) {
                DB::table('document_operations')
                    ->where('document_id', $invoiceId)
                    ->where('document_type', 'invoice')
                    ->delete();
            }
            $total = 0;
            foreach ($request->rows as $row) {
                $invoiceItem = new InvoiceItems();
                $invoiceItem->invoice_id = $invoiceId;
                $invoiceItem->product_id = $row["product_id"];
                $invoiceItem->unit_id = $row["unit_id"];
                $invoiceItem->fact_qty = $row["fact_qty"];
                $invoiceItem->price_per_unit = $row["total"]/$row["fact_qty"];
                $invoiceItem->quantity = $row["quantity"];
                $invoiceItem->price = $row["price"];
                $invoiceItem->total = $row["total"];
                $total = $total + $row["total"];
                $invoiceItem->save();
                if (intval($request->status_id) === 2) {
                    // Use PostgreSQL function to create document operation
                    $documentOperationData = [
                        'operation_date' => $request->invoice_date,
                        'operation_number' => $request->invoice_number,
                        'document_id' => $invoiceId,
                        'document_type' => 'iinv',
                        'operation_dt' => '281',
                        'subconto_dt' => json_encode(array(
                            'store_id' => $request->store_id,
                            'store_name' => $store->name,
                            'product_id' => $row["product_id"],
                            'product_name' => $row['product'],
                            'producer_id' => $producer->id,
                            'producer_name' => $producer->name,
                            'fact_qty' => $row['fact_qty'],
                            'price_per_unit' => number_format(($row['total']/$row['fact_qty']), 2)
                        )),
                        'operation_kt' => '631',
                        'subconto_kt' => json_encode(array(
                            'producer_id' => $request->producer_id,
                            'producer_name' => $producer->name
                        )),
                        'amount' => $row["total"],
                        'quantity' => $row["quantity"],
                        'comment' => 'income_products'
                    ];
                    
                    DB::statement('SELECT create_document_operation(?, ?, ?, ?, ?, ?::jsonb, ?, ?::jsonb, ?, ?, ?)', [
                        $documentOperationData['operation_date'],
                        $documentOperationData['operation_number'],
                        $documentOperationData['document_id'],
                        $documentOperationData['document_type'],
                        $documentOperationData['operation_dt'],
                        $documentOperationData['subconto_dt'],
                        $documentOperationData['operation_kt'],
                        $documentOperationData['subconto_kt'],
                        $documentOperationData['amount'],
                        $documentOperationData['quantity'],
                        $documentOperationData['comment']
                    ]);
                    
                    // Use PostgreSQL function to update store materials
                    $material = Material::find($row["product_id"]);
                    $storeMaterialsData = [
                        'doc_date' => $request->invoice_date,
                        'document_type' => 'iinv',
                        'document_id' => $invoiceId,
                        'store_id' => $request->store_id,
                        'material_id' => $row["product_id"],
                        'qty' => $row["quantity"],
                        'unit_id' => $material->unit_id,
                        'fact_qty' => $row['fact_qty'],
                        'fact_unit_id' => $material->weightunit_id,
                        'price_per_unit' => number_format(($row['total']/$row['fact_qty']), 2),
                        'producer_id' => $request->producer_id
                    ];
                    
                    DB::statement('SELECT update_store_materials(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)', [
                        $storeMaterialsData['doc_date'],
                        $storeMaterialsData['document_type'],
                        $storeMaterialsData['document_id'],
                        $storeMaterialsData['store_id'],
                        $storeMaterialsData['material_id'],
                        $storeMaterialsData['qty'],
                        $storeMaterialsData['unit_id'],
                        $storeMaterialsData['fact_qty'],
                        $storeMaterialsData['fact_unit_id'],
                        $storeMaterialsData['price_per_unit'],
                        $storeMaterialsData['producer_id']
                    ]);
                }
            }
            // create operations
            if (intval($request->status_id) === 2) {
                // Use PostgreSQL function for VAT entry
                $documentOperationData = [
                    'operation_date' => $request->invoice_date,
                    'operation_number' => $request->invoice_number,
                    'document_id' => $invoiceId,
                    'document_type' => 'iinv',
                    'operation_dt' => '6442',
                    'subconto_dt' => json_encode(array('name' => 'nds')),
                    'operation_kt' => '631',
                    'subconto_kt' => json_encode(array('producer_id' => $request->producer_id, 'name' => $producer->name)),
                    'amount' => $total*20/100,
                    'quantity' => 0,
                    'comment' => 'nds'
                ];
                
                DB::statement('SELECT create_document_operation(?, ?, ?, ?, ?, ?::jsonb, ?, ?::jsonb, ?, ?, ?)', [
                    $documentOperationData['operation_date'],
                    $documentOperationData['operation_number'],
                    $documentOperationData['document_id'],
                    $documentOperationData['document_type'],
                    $documentOperationData['operation_dt'],
                    $documentOperationData['subconto_dt'],
                    $documentOperationData['operation_kt'],
                    $documentOperationData['subconto_kt'],
                    $documentOperationData['amount'],
                    $documentOperationData['quantity'],
                    $documentOperationData['comment']
                ]);
            }

            return Redirect::route('invoice.incoming.index');
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(Invoice $invoice) {
        //
    }
}
